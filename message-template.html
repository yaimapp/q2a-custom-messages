<div class="centering__width-640 mdl-card mdl-cell mdl-cell--12-col margin--top-16px padding--16px">
    <div class="messages">
    <?php foreach ($messages as $message): ?>
      <div class="message-container <?php echo $message['status']; ?>">
          <div class="avatar">
            <img src="../?qa=image&amp;qa_blobid=<?php echo $message['avatarblobid']; ?>&amp;qa_size=60" width="60" height="60" class="qa-avatar-image" alt="">
          </div>
          <div class="message" id="m<?php echo $message['messageid']; ?>">
            <?php if (isset($message['handle'])): ?>
            <span class="date mdl-typography--caption mdl-color-text--grey-500" <?php echo $message['handle_align']; ?>>
              <?php echo $message['handle']; ?>
            </span>
            <?php endif; ?>
            <div class="<?php echo $message['color']; ?> ballon padding--16px">
                <?php echo $message['content']; ?>
            </div>
            <span class="date mdl-typography--caption mdl-color-text--grey-500" style="<?php echo $message['textalign']; ?>"><?php echo $message['created']; ?></span>
            <?php if($message['deleteable']): ?>
            <a class="date mdl-typography--caption delete-message" style="<?php echo $message['textalign']; ?>" data-id="<?php echo $message['messageid']; ?>">
              <?php echo qa_lang('custom_messages/label_delete'); ?>
            </a>
            <?php endif; ?>
          </div>
      </div>
    <?php endforeach; ?>
    </div>

</div>

<dialog id="delete-message-confirm" class="mdl-dialog">
  <h4><?php echo qa_lang_html('custom_messages/confirm_delete'); ?></h4>

  <div class="mdl-dialog__actions">
    <button class="mdl-button close" type="button">
      <?php echo qa_lang_html('custom_messages/label_no'); ?>
    </button>
    <button class="mdl-button delete-button" type="button">
      <?php echo qa_lang_html('custom_messages/label_yes'); ?>
    </button>
  </div>
</dialog>

<script>
$(function(){
  var base_url = '<?php echo qa_opt("site_url"); ?>';
  // 削除確認ダイアログ
  var dialog = document.querySelector('#delete-message-confirm');
  var target_messageid = null;
  if (! dialog.showModal) {
    dialogPolyfill.registerDialog(dialog);
  }
  $('.delete-message').click(function() {
    target_messageid = $(this).data('id');
    dialog.showModal();
  });
  dialog.querySelector('.close').addEventListener('click', function() {
    dialog.close();
  });
  dialog.querySelector('.delete-button').addEventListener('click', function() {
    delete_message(target_messageid);
    dialog.close();
  });

  function delete_message(target_messageid) {
    var delete_ajax_url = base_url + 'delete-message';
    $.ajax({
      url: delete_ajax_url,
      type: 'POST',
      dataType: 'json',
      cache : false,
      data: { messageid: target_messageid }
    })
    .done(function(res, status, xhr) {
        if (xhr.status === 200) {
            var msgbox = $('#m'+target_messageid).children('div');
            msgbox.html(res.content);
        } else {
            console.log(xhr.status);
            console.log(res);
        }
    })
  }
});
</script>
